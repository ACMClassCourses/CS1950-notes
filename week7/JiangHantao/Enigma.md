# Enigma

加粗的部分为上课时[我记住]的内容，即True Lecture Notes；其他的是一些补充。

### 1 Intro of Enigma

Enigma 密码机本质上使用对称加密算法（其加密和解密使用相同密钥）的流加密（依赖单独加密的密钥，先用其他方法加密密钥，将其放在文件头，然后使用这串密钥来加密或解密数据）方法进行加密解密。

**Enigma 最重要的部件为三个26齿转子，以及连接键盘和显示器中的相同字母的“反射器”。**

**这里重点讲一下“反射器”。**其发明者亚瑟·谢尔比乌斯 (Arthur Scherbius) 在设计中，创造性地将键盘和显示器中的相同字母用电线连接在一起。当一个键被按下，信号不是直接从键盘传到显示器，而是首先通过三个转子连成的一条线路，然后经过反射器再回到三个转子，通过另一条线路再到达显示器上。比如说A键被按下时，亮的是显示器上的D灯泡。如果这时按的不是A键而是D键，那么信号恰好按照上面A键被按下时的相反方向通行，最后到达A灯泡。这样，在相同的流加密初始密钥下，只要输入不出错，输入密文可以完美复现明文。这样既安全又高效，不失为一种设计艺术。

![密码学发展简史_密码学发展史_问我学院的博客-CSDN博客](https://img-blog.csdnimg.cn/20190417172918110.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2ppYW5nX3hpbnhpbmc=,size_16,color_FFFFFF,t_70)

关于“流加密”性质的体现：实际战争中，以六个字母组成的字符串作为流加密密钥（**这是 Enigma 为数不多的弱点之一**）。每天要发送密件时，首先发一个新的密钥。此时，连接板的连线顺序和转子的顺序并不改变，和当日通用的密钥相同。操作员会按照上面所说的方法按当日密钥调整好 Enigma 三个转子的初始状态，然后随机地选择三个字母，作为之后的转子初态，比如说PGH。他把PGH在键盘上连打两遍，加密为比如说KIVBJE（注意到两次PGH被加密为不同的形式，第一次KIV，第二次BJE，这正是ENIGMA的特点，它是一种复式替换密码）。然后他把KIVBJE记在电文的最前面，作为“头密钥”。接着他重新调整三个转子的初始方向到PGH，然后才正式对明文加密。这样，接收方首先收到了密钥，调整Enigma后先输入头密钥 (KIVBJE)，得到 PGHPGH ，然后以 PGH 作为转子的初始值解密后面的文字。这样，唯一的不安全性来自于那串一开始发送的“当日密钥”。

### 2 Impossible to break Enigma

**古代密码多为单表替换密码 (Mono-alphabetic Cipher)，比如凯撒密码 (Caesar Cipher)。这类密码由于西文字母使用中的频率差别显著，并且字母与字母间必须一一对应，导致可以用频率法快速破解。**

**Enigma 通过三个26齿转子实现了多表替换加密 (Poly-alphabetic Cipher)，换句话说，同一个字母在明文的不同位置时，可以被不同的字母替换，而密文中不同位置的同一个字母，又可以代表明文中的不同字母。**先前使用多表替换加密的简单密码有 Playfair 密码，Polybius 密码和 Vigenere 密码等。其中即使是比较复杂的 Vigenere 密码，也被巴贝奇 (Babbage) 破解了。其可破解性关键来自于其密钥是循环重复的，在知道密钥长度后，密文就可以看做一个“凯撒密码二维数组”，其中每一个都是原文与秘钥的固定一一对应，因此都可以单独破解。欲详细了解，请看[CTF wiki](https://ctf-wiki.org/crypto/classical/polyalphabetic/)。

<img src="https://ctf-wiki.org/crypto/classical/figure/vigenere1.jpg" alt="维吉尼亚表格" style="zoom: 67%;" />

![维吉尼亚加密](https://ctf-wiki.org/crypto/classical/figure/vigenere2.jpg)

在上面，以密文和周期重复的密钥为$(x,y)$坐标，一一对应即得明文。

关于多表替换的一个实例：假如使用三表（“表”即密钥与密文的一种对应关系）替换，出现$SSSSSS\stackrel{\text{key='cat'}}{\longrightarrow}USLUSL$的现象，这样的加密具有的周期为3，应用之前的多表替换知识，是可破解的。

**但是 Enigma 的不可破解性，在于使用了三个26位转子，这样可以创造出$26^3=17576$张不同的表，使得密码周期接近两万。同时，由于三个转子初始值可以不同，连接板（见第一个图）、反射器上电线连接方式更是未知，全部计算下来，其可能性为$10^{20}$数量级，完全没可能暴力破解，即使使用的只是对称加密算法。**再加上实战中德军每天都会更换新的密钥，每隔一段时间升级设备重组连接板和反射器，这使得破解希望更渺茫。

### 3 Permutation $\neq$ Transportation

这是一小部分内容。大致是说，**Enigma 密码机使用了“置换”而不是“转移”的思路。假如使用“翻译”处理$ABCDE$，得到$STIKA$，那么在这台机器上任意时刻键入$STIKA$都会输出$ABCDE$；但是使用“置换”得到$STIKA$，就会得到另一串完全没有联系的数据。**这是其安全性的一个保证，也是其作为多表替换密码的优越性体现。

更具体的说，所谓“置换”由接线板、3个转子和反射器负责。每次输入一字母，我们用$S,L,M,N,R,H$分别代表插头式配电盘（输入模式，因为从键盘到第一个转子也存在一个数据变化）、转子右、中、左、回滚器、初始滚筒（initial drum, 作为从输入到左转子数据的转移器）所造成的数据变换，那么类似矩阵乘法，为描述这次输入-输出变换，我们有
$$
SHNMLRL^{-1}M{-1}H^{-1}S^{-1}
$$
一次输入后，$N$转了一格，那么定义置换$P$，其将$N$之后的操作都在字母表上“右移”一格（比如$a\to b$）。那么对于第二次操作，其变换式为
$$
SHPNP^{-1}MLRL^{-1}M^{-1}PN^{-1}P^{-1}H^{-1}S^{-1}
$$
以此类推，每次某一个转子转了一格，给它和后面受影响的变换乘以$P$。

在知道输入模式$S$，初始滚筒接线$H$，转子初态（这个可以在了解德军的“前六位”密钥法后，通过截获“当日密钥”得出）$L,M,N$，以及反射器$R$后，这些操作基本上都可以量化。详细的可以参考论文：Marian Rejewski的How Polish Mathematicians Deciphered the Enigma，在文件夹中。